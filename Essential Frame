import discord
from discord.ext import tasks, commands


# 봇 토큰과 채널 ID 설정
TOKEN = 'token_'  # 디스코드 개발자 포털에서 복사한 봇 토큰
CHANNEL_ID = 1265924339870597151  # 메시지를 게시할 디스코드 채널의 ID


intents = discord.Intents.default()
bot = commands.Bot(command_prefix='/', intents=intents)


content = """
□ 운영 개요

○ 대상: 재학생[학부 및 대학원(일반, 전문, 특수)], 휴학생(복학예정자)

※ 단, 2024학년도 1학기 기준 신입생 및 편입생은 제외

○ 기간: 2024. 7. 29.(월) 09:00 ~ 7. 31.(수) 18:00

○ 대상강좌: 2024학년도 제2학기 개설 교과목 전체

○ 수강신청 방법: 수강신청시스템(https://sugang.cnu.ac.kr/) → 로그인 → ‘예비수강신청 화면으로 이동’ 클릭(또는 수강관리 → 예비수강신청)  ※ 컴퓨터(웹)로만 수강신청 가능

○ 예비수강신청 내역 확인: 수강신청시스템 - ‘예비수강신청내역조회’

○ 유의사항 [중요★]

- ‘우선확정’(구. 밀어주기) 과목을 제외한 그 외 과목은 실제 수강신청이 되거나 우선순위가 보장되는 것이 아니므로 반드시 본 수강신청 기간에 별도                                                                      - 예비수강신청 이후 강의일람(담당 교원, 시간표, 강의실 등)이 변경될 수 있으니 본 수강신청 전 수강일람(시간표 등) 재확인

□ 예비수강신청 「우선확정」(구. 밀어주기) 안내

○ ‘우선확정’이란?

- ‘우선확정’ 대상 과목 중, 예비수강신청 기간 종료 후 우선확정 수강정원 내로 수강신청된 과목은 일괄 수강 확정 처리하는 제도

※ 학생은 본 수강신청 시 별도로 수강신청할 필요 없음

※ ‘밀어주기’에서 이해하기 쉬운 용어로 변경(΄24. 1학기~)

○ 대상 과목: 4차산업혁명시대를위한인문학입문 등 598강좌[붙임2 참조]

○ ‘우선확정’ 결과(일괄 수강신청 처리) 개별 확인

- 확인 방법: 2024. 8. 1.(목) 18:00 이후 통합정보시스템 - ‘수강신청내역 조회’
→ ‘수강내역’확인(확정된 경우 수강내역에 해당 과목이 확인됨)

○ 유의사항: 수강정원이 초과되어 수강신청이 확정되지 않은 경우 본 수강신청 기간 선착순으로 수강신청을 하여야 수강신청이 확정됨

□ 예비 수강신청 관련 FAQ

Q1. 예비수강신청을 하면 수강신청이 확정되는 건가요?

A1. 아닙니다!!
본 수강신청 때 선착순으로 정원 내‘확정하기’버튼을 누른 경우에 수강신청이 확정됩니다.

※ 단, 정원 내 ‘우선확정’으로 수강신청 확정된 과목은 제외(상단 참조)

Q2. 실제 수강신청 시 예비수강신청을 신청한 과목만 신청이 되나요?

A2. 아닙니다.
본 수강 신청 때 예비수강을 신청하지 않은 과목도 신청 가능합니다.

Q3. 예비수강신청은 반드시 해야 하나요?

A3. 아닙니다. 개인 선택사항입니다.

Q4. 예비수강신청에서 담아놓은 과목의 강의일람(강의시간, 강의실, 교수)이 바뀔 수 있나요?

A4. 개설학과 사정에 따라 본 수강신청 시 변경될 수 있습니다.
반드시 본 수강신청 전 강의시간과 강의실을 확인해 주시기 바랍니다.

Q5. ‘우선확정’대상 과목 중 정원이 초과되었습니다. 본 수강신청 때 선착순으로 예비수강신청한 순서로 확정되나요?

A5. 아닙니다.
본 수강신청 기간 동안에 선착순으로 수강 신청한 순서로 확정됩니다.

Q6. 예비수강신청도 선착순으로 신청해야하나요?

A6. 아닙니다.
‘우선확정’ 과목도 예비수강신청 기간 종료 후, 최종 정원으로 판단하기 때문에 선착순으로 하지 않아도 됩니다.

Q7. ‘우선확정’으로 확정된 경우 본 수강신청 때 취소가 가능한가요?

A7. 가능합니다.
본 수강신청 기간 동안 수강신청 화면에서 수강신청 내역에 있는 과목 중 앞에 ‘삭제’ 버튼을 누르면 취소됩니다.
""".strip()


@bot.event
async def on_ready():
    print(f'We have logged in as {bot.user}')
    fetch_data.start()  # 봇이 준비되면 데이터 가져오는 작업 시작


@tasks.loop(hours=1/60)  # 1분마다 실행
async def fetch_data():
    channel = bot.get_channel(CHANNEL_ID)
    if channel:
        embed = discord.Embed(title="2024학년도 제2학기 예비수강신청 안내", color=0x0000ff)

        # 이미지 파일 경로 설정
        img_path = "img.png"

        # 파일을 열어 디스코드 파일 객체로 변환
        with open(img_path, 'rb') as img_file:
            picture = discord.File(img_file, filename="img.png")

        await channel.send(file=picture, embed=embed
            .set_footer(text=content)
            .set_image(url="attachment://img.png")
            .set_image(
                url="https://ai.cnu.ac.kr/_attach/image/editor_image/2024/07/QUskuRVkFrRgrosPTiXr0.png"
            )
            .set_image(
                url="https://ai.cnu.ac.kr/_attach/image/editor_image/2024/07/IKIpyrHnHNLxmVYBQuoc0.png"
            )
        )


@fetch_data.before_loop
async def before_fetch_data():
    await bot.wait_until_ready()


if __name__ == '__main__':
    bot.run(TOKEN)
